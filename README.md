# Splunk Add-on For Azure Monitor Logs

This add-on was built in accordance with the guidelines on this page:<br/>
[How to work with modular inputs in the Splunk SDK for JavaScript](http://dev.splunk.com/view/javascript-sdk/SP-CAAAEXM)

It consumes Diagnostic Logs according to the techniques defined by Azure Monitor, which provides highly granular and real-time monitoring data for any Azure resource, and those selected by the user's configuration and sends them along to Splunk.

Here are a few resources if you want to learn more:<br/>
* [Overview of Azure Monitor](https://docs.microsoft.com/en-us/azure/monitoring-and-diagnostics/monitoring-overview)
* [Overview of Azure Diagnostic Logs](https://docs.microsoft.com/en-us/azure/monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs)

## Installation
Until the add-on is in Splunkbase, installation is manual.<br/><br/>
To install, clone into $SPLUNK_HOME/etc/apps/azureLogs. Restart Splunk. In the Splunk UI, you should now see it on the Manage Apps page as "Splunk Add-on for Azure Monitor". In Settings/Data Inputs, you should see it as "Azure Monitor Logs". Add an instance and supply the values denoted in the following Inputs section. 

The add-on wants to checkpoint in `$SPLUNK_DB/modinputs/azureLogs`. On a Windows system, SYSTEM needs read/write/update permissions, and $SPLUNK_DB is `c:\program files\splunk\var\lib\splunk`. Add the directory and set permissions via Windows Explorer. 

## Inputs are: (all are required)

| Input Name | Example | Notes |
|------------|---------|-------|
| subscriptionId | `7X3X6Xd6-8XX8-46XX-8XXd-eaXXXXXXX52d` | your azure subscription id |
| resourceGroup | `myResourceGroup` | the resource group containing resources that you want logs from |
| tenantId | `XXXX88bf-XXXX-41af-XXXX-XXXXd011XXXX` | your Azure AD tenant id |
| clientId | `0edc5126-XXXX-4f47-bd78-XXXXXXXXXXXX` | your Service Principal Application ID |
| clientSecret | `7lqd4scZWpxjBe6dQyYBY2bFjk+8jio9iOvCv65gf9w=` | your Service Principal password |
| eventHubNamespace | `myEventHubNamespace` | the namespace of the event hub receiving logs |
| sasKeyName | `RootManageSharedAccessKey` | the SAS key associated with your event hub namespace |
| sasKeyValue | `ZhLwp9lsVWQt5UFgnogJXFbMnD8RDuHWgY0J9RN1ctE=` | the SAS password associated with that SAS key |

Click the "More Settings" box and provide the following: (required)
* Interval = 60
* Set sourcetype = manual
* Source Type = azureMonitorLogs
* Index = main

## Resource tags: (required)

All ARM resources can have an arbitrary collection of tags associated with them. Tell the add-on to send logs for a resource to Splunk by adding a tag to it named DiagnosticLogs and set its value to True. This can be done in various ways including the portal.<br/>
*If you don't put in the tags, you won't get any logs.*<br/>
To learn more: [Use tags to organize your Azure resources](https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-using-tags)

## config.json
config.json provides for each log category the name of the hub written to. Multiple log categories may be written by a single resource type. It also identifies the name of the resource ID property on a resourceType-by-resourceType basis.

## How it works
This modular input assumes that you have a set of Azure resources (such as VMs, networks, storage) in a resource group. You want to monitor those resources as a group.<br/>

### Step-by-Step (The add-on is invoked once per minute by Splunk Enterprise)
* Get an authentication token for ARM api's.
* Get the list of hubs in the event hub namespace
* Get the list of resources in the resource group
* For each resource in the list, see if the DiagnosticLogs tag is True.
* From these data, determine which hubs to 'listen to'
* For each of those hubs, create a listener
* Wait for messages, passing along into Splunk as needed
* If there's 1 second of silence across all hubs, terminate

## Logging

Logs are generated by Logger. Errors and Warnings will appear in splunkd.log which is located at $SPLUNK_HOME/var/log/splunk. On a Windows system, $SPLUNK_HOME is c:\program files\splunk. Most logs are in the debug log level. To change the log level, go to Settings / Server Settings / Server Logging. Search for ExecProcessor in the very long list of log channels. Change its value to whatever you want and save. It'll reset to info upon restarting Splunk unless you change it permanently via other means.

# Contributing

This project has adopted the [Microsoft Open Source Code of Conduct](https://opensource.microsoft.com/codeofconduct/). For more information see the [Code of Conduct FAQ](https://opensource.microsoft.com/codeofconduct/faq/) or contact [opencode@microsoft.com](mailto:opencode@microsoft.com) with any additional questions or comments.
